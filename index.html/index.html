<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gagnvirkt Gl√∫tenlaust Matarplan - Gervigreindar√∫tg√°fa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Neutrals (Stone, Teal) -->
    <!-- Application Structure Plan: The app retains its yearly/monthly/weekly structure. The "AI Assistant" section is a 3-column grid. A print button is added to each weekly view. A new "Note" textarea is added to the weekly view for user-specific notes. -->
    <!-- Visualization & Content Choices: A print button is added to each weekly view. Print-specific CSS (@media print) is used to format the output. A new textarea for notes is added under the weekly menu. Interaction: User can type freely into the textarea. This content is included in the print-out. Justification: Adding a notes section provides crucial flexibility for users to add personal reminders or modifications to their weekly plan. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: auto;
            margin-left: auto;
            margin-right: auto;
        }
        .recipe-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%230F766E%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: .65em auto;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14b8a6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #plan-content, #plan-content * {
                visibility: visible;
            }
            #plan-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-hide {
                display: none !important;
            }
            .week-content .grid {
                display: block !important;
            }
            .recipe-accordion-content {
                max-height: none !important;
                visibility: visible !important;
                display: block !important;
            }
            .recipe-accordion-toggle svg {
                display: none;
            }
            .week-content {
                box-shadow: none !important;
                border: none !important;
            }
            textarea {
                border-color: #000 !important;
                color: #000 !important;
            }
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8 print-hide">
            <h1 class="text-4xl md:text-5xl font-bold text-teal-800">Gl√∫tenlaust √Årsplan</h1>
            <p class="mt-2 text-lg text-stone-600">Hagkv√¶mt og fj√∂lbreytt matarplan fyrir allt √°ri√∞, n√∫ me√∞ gervigreind.</p>
        </header>

        <section class="mb-8 p-6 bg-white rounded-2xl shadow-md flex flex-col sm:flex-row justify-center items-center gap-4 print-hide">
             <label for="month-selector" class="text-xl font-bold text-teal-700">Veldu m√°nu√∞:</label>
             <select id="month-selector" class="p-3 border-2 border-teal-200 rounded-lg text-lg font-semibold text-teal-800 bg-white focus:ring-2 focus:ring-teal-500 focus:border-teal-500 w-full sm:w-auto">
             </select>
        </section>

        <!-- Gemini AI Assistant Section -->
        <section class="my-12 p-6 bg-teal-50 rounded-2xl shadow-md print-hide">
            <h2 class="text-3xl font-bold text-center mb-6 text-teal-800">Gervigreindar a√∞sto√∞arma√∞ur</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- New Recipe Generator -->
                <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col">
                    <h3 class="text-2xl font-bold mb-4 text-teal-700">T√∂frauppskrift ‚ú®</h3>
                    <p class="text-stone-600 mb-4 flex-grow">Vantar √æig hugmynd a√∞ kv√∂ldmat? Skrifa√∞u hr√°efni e√∞a nafn √° r√©tt og vi√∞ semjum n√Ωja uppskrift.</p>
                    <input type="text" id="new-recipe-prompt" placeholder="t.d. Kj√∫klingur og beikon" class="w-full p-2 border border-stone-300 rounded-md mb-4">
                    <button id="generate-new-recipe-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-teal-700 transition-colors mt-auto">B√∫a til kv√∂ldmat</button>
                </div>
                <!-- Leftover Helper -->
                <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col">
                    <h3 class="text-2xl font-bold mb-4 text-teal-700">N√Ωta afganga ‚ú®</h3>
                    <p class="text-stone-600 mb-4 flex-grow">Skrifa√∞u hva√∞ √æ√∫ √°tt til √≠ √≠ssk√°pnum og vi√∞ finnum lei√∞ til a√∞ n√Ωta √æa√∞ √≠ m√°lt√≠√∞.</p>
                    <textarea id="leftover-prompt" placeholder="t.d. h√°lfur laukur, 2 gulr√¶tur, so√∞inn kj√∫klingur" class="w-full p-2 border border-stone-300 rounded-md mb-4" rows="3"></textarea>
                    <button id="generate-leftover-recipe-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-teal-700 transition-colors mt-auto">Finna uppskrift √∫r afg√∂ngum</button>
                </div>
                <!-- Lunch Helper -->
                <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col">
                    <h3 class="text-2xl font-bold mb-4 text-teal-700">L√©ttur H√°degismatur ü•ó</h3>
                    <p class="text-stone-600 mb-4 flex-grow">F√°√∞u hugmynd a√∞ einf√∂ldum og l√©ttum h√°degisver√∞i. Sl√°√∞u inn √≥skir √æ√≠nar.</p>
                    <input type="text" id="lunch-recipe-prompt" placeholder="t.d. salat me√∞ kj√∫klingi, ommiletta" class="w-full p-2 border border-stone-300 rounded-md mb-4">
                    <button id="generate-lunch-recipe-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-teal-700 transition-colors mt-auto">B√∫a til h√°degismat</button>
                </div>
            </div>
        </section>

        <section id="chart-section" class="mb-12 p-6 bg-white rounded-2xl shadow-md print-hide" style="display: none;">
            <h2 id="chart-title" class="text-2xl font-bold text-center mb-4 text-teal-700"></h2>
            <p class="text-center text-stone-600 mb-6">Hlutfall helstu hr√°efna √≠ kv√∂ldm√°lt√≠√∞um m√°na√∞arins.</p>
            <div class="chart-container">
                <canvas id="mealTypeChart"></canvas>
            </div>
        </section>

        <nav id="week-nav" class="flex justify-center flex-wrap gap-2 mb-8 print-hide" style="display: none;">
        </nav>

        <main id="plan-content">
        </main>
    </div>

    <!-- Modal for AI results -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden print-hide">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 sm:p-8">
            <div class="flex justify-between items-center mb-4">
                <h2 id="ai-modal-title" class="text-2xl font-bold text-teal-800">Tillaga fr√° Gervigreind</h2>
                <button id="close-ai-modal-btn" class="text-stone-500 hover:text-stone-800 text-3xl font-bold">&times;</button>
            </div>
            <div id="ai-modal-content">
                <!-- Loader will be injected here -->
            </div>
        </div>
    </div>


    <script>
        const masterRecipes = [
            { title: "Bollur √≠ karr√Ω", category: "Sv√≠nakj√∂t", content: "<b>Bollur:</b> 500g hakk, 1 dl gl√∫tenlaust haframj√∂l, 1 egg, 1/2 rifinn laukur, 1 dl mj√≥lk, salt & pipar. Hno√∞i√∞, m√≥ti√∞ bollur, steiki√∞. <br><b>S√≥sa:</b> Steiki√∞ 1/2 saxa√∞an lauk og 1 rifi√∞ epli. B√¶ti√∞ vi√∞ 2 msk karr√Ω og 1 msk gl√∫tenlausu mj√∂li. Helli√∞ 5 dl vatni/so√∞i og 1 d√≥s k√≥kosmj√≥lk/rj√≥ma √∫t √≠. L√°ti√∞ bollurnar malla √≠ s√≥sunni. Beri√∞ fram me√∞ hr√≠sgrj√≥num.", ingredients: { "Kj√∂t & Fiskur": ["Sv√≠nahakk e√∞a blandahakk (500g)"], "Gr√¶nmeti & √Åvextir": ["Laukur (1)", "Epli (1)"], "Mj√≥lkurv√∂rur & Egg": ["Egg (1)", "Mj√≥lk (1 dl)", "Rj√≥mi e√∞a k√≥kosmj√≥lk (1 d√≥s)"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Gl√∫tenlaust haframj√∂l (1 dl)", "Hr√≠sgrj√≥n", "Karr√Ω"] } },
            { title: "Pottfiskur/Plokkfiskur", category: "Fiskur", content: "Sj√≥√∞i√∞ 600-800g fisk og 6-8 kart√∂flur. Geymi√∞ so√∞i√∞. Br√¶√∞i√∞ 3 msk smj√∂r, hr√¶ri√∞ 3 msk gl√∫tenlausu mj√∂li saman vi√∞. √ûynni√∞ me√∞ mj√≥lk og fiskiso√∞i (ca 5-6 dl samtals). Stappi√∞ kart√∂flur, r√≠fi√∞ fiskinn ni√∞ur, saxi√∞ 1 lauk og blandi√∞ √∂llu saman. Kryddi√∞.", ingredients: { "Kj√∂t & Fiskur": ["√ùsu- e√∞a √æorskfl√∂k (600-800g)"], "Gr√¶nmeti & √Åvextir": ["Kart√∂flur (6-8 stk)", "Laukur (1)"], "Mj√≥lkurv√∂rur & Egg": ["Smj√∂r", "Mj√≥lk (3 dl)"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Gl√∫tenlaust mj√∂l (3 msk)"] } },
            { title: "Kj√∫klingar√©ttur √≠ ofni", category: "Kj√∫klingur", content: "Setji√∞ 800g-1kg kj√∫kling, kart√∂flur, gulr√¶tur og lauk √≠ ofnsk√∫ffu. Helli√∞ ol√≠u yfir og kryddi√∞ me√∞ salti, pipar, papriku. Baki√∞ vi√∞ 200¬∞C √≠ 40-50 m√≠n.", ingredients: { "Kj√∂t & Fiskur": ["Kj√∫klingal√¶ri e√∞a -bitar (800g-1kg)"], "Gr√¶nmeti & √Åvextir": ["Kart√∂flur", "Gulr√¶tur", "Laukur"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Paprikukrydd", "√ìl√≠fuol√≠a"] } },
            { title: "Heimager√∞ir hakkaborgarar", category: "Nauta-/Hestakj√∂t", content: "Blandi√∞ 500g hakki, 1 tsk laukdufti, salti og pipar. M√≥ti√∞ borgara, steiki√∞ og setji√∞ ost yfir. Beri√∞ fram √≠ gl√∫tenlausu brau√∞i me√∞ me√∞l√¶ti.", ingredients: { "Kj√∂t & Fiskur": ["Nauta- e√∞a hestahakk (500g)"], "Mj√≥lkurv√∂rur & Egg": ["Rifinn ostur"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Gl√∫tenlaus hamborgarabrau√∞", "Laukduft"], "Gr√¶nmeti & √Åvextir": ["Salat", "T√≥matar", "G√∫rka"] } },
            { title: "Gl√∫tenlaust Lasagne", category: "Nauta-/Hestakj√∂t", content: "<b>Kj√∂ts√≥sa:</b> Steiki√∞ 500g hakk, 1 lauk, 2 gulr√¶tur. B√¶ti√∞ vi√∞ 2 d√≥sum t√≥m√∂tum, 1 msk t√≥matp√∫rru, kryddi. L√°ti√∞ malla. <br><b>Hv√≠t s√≥sa:</b> Br√¶√∞i√∞ 3 msk smj√∂r, hr√¶ri√∞ 3 msk gl√∫tenlausu mj√∂li √∫t √≠. √ûynni√∞ me√∞ 6 dl mj√≥lk. Setji√∞ s√≥sur og gl√∫tenlausar pl√∂tur til skiptis √≠ m√≥t. Ostur yfir. Baki√∞ vi√∞ 180¬∞C √≠ 30-40 m√≠n.", ingredients: { "Kj√∂t & Fiskur": ["Nautahakk (500g)"], "Gr√¶nmeti & √Åvextir": ["Laukur (1)", "Gulr√¶tur (2)"], "Mj√≥lkurv√∂rur & Egg": ["Rifinn ostur", "Smj√∂r", "Mj√≥lk (6 dl)"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Ni√∞urso√∞nir t√≥matar (2 d√≥sir)", "T√≥matp√∫rra", "Gl√∫tenlausar lasagne-pl√∂tur"] } },
            { title: "Kj√∂ts√∫pa", category: "Lambakj√∂t", content: "Setji√∞ 1 kg s√∫pukj√∂t √≠ pott me√∞ vatni. Fleyti√∞ fro√∞u. B√¶ti√∞ vi√∞ ni√∞urskornu r√≥targr√¶nmeti og kart√∂flum. L√°ti√∞ malla √≠ a.m.k. 1 klst.", ingredients: { "Kj√∂t & Fiskur": ["Lambas√∫pukj√∂t (1 kg)"], "Gr√¶nmeti & √Åvextir": ["R√≥targr√¶nmeti (s√∫pujurtir)", "Kart√∂flur"] } },
            { title: "Frikadellur", category: "Sv√≠nakj√∂t", content: "Sama grunnuppskrift og fyrir bollur, en m√≥ti√∞ √æ√¶r flatari. Steiki√∞. <br><b>Br√∫n s√≥sa:</b> Br√¶√∞i√∞ smj√∂r, b√¶ti√∞ vi√∞ 2 msk gl√∫tenlausu mj√∂li. Helli√∞ so√∞i (ca. 4-5 dl) √∫t √≠ sm√°tt og sm√°tt. Beri√∞ fram me√∞ so√∞num kart√∂flum.", ingredients: { "Kj√∂t & Fiskur": ["Sv√≠nahakk e√∞a blandahakk (500g)"], "Mj√≥lkurv√∂rur & Egg": ["Egg (1)", "Mj√≥lk (1 dl)"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Gl√∫tenlaust haframj√∂l (1 dl)"], "Gr√¶nmeti & √Åvextir": ["Kart√∂flur"] } },
            { title: "Hakka-k√°ssa (Chili st√≠ll)", category: "Nauta-/Hestakj√∂t", content: "Steiki√∞ 500g nautahakk, 1 saxa√∞an lauk og 2 hv√≠tlauksrif. B√¶ti√∞ vi√∞ 1 d√≥s h√∂kku√∞um t√≥m√∂tum, 1 d√≥s n√Ωrnabaunum, 1 tsk chili dufti og 1 tsk cumin. L√°ti√∞ malla √≠ 15-20 m√≠n. Beri√∞ fram me√∞ hr√≠sgrj√≥num og s√Ωr√∞um rj√≥ma.", ingredients: { "Kj√∂t & Fiskur": ["Nautahakk (500g)"], "Gr√¶nmeti & √Åvextir": ["Laukur (1)", "Hv√≠tlaukur (2 rif)"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Ni√∞urso√∞nir t√≥matar (1 d√≥s)", "N√Ωrnabaunir (1 d√≥s)", "Chili duft", "Cumin", "Hr√≠sgrj√≥n"], "Mj√≥lkurv√∂rur & Egg": ["S√Ωr√∞ur rj√≥mi"] } },
            { title: "Gl√∫tenlaus pizza", category: "Anna√∞", content: "Noti√∞ tilb√∫na botna e√∞a blandi√∞ deig. Setji√∞ pizzas√≥su, ost og upp√°halds √°leggi√∞ ykkar √°. Baki√∞ samkv√¶mt lei√∞beiningum.", ingredients: { "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Gl√∫tenlausir pizzabotnar", "Pizzas√≥sa"], "Mj√≥lkurv√∂rur & Egg": ["Rifinn ostur"], "Kj√∂t & Fiskur": ["Pizza√°legg a√∞ eigin vali"] } },
            { title: "Sv√≠nag√∫llas", category: "Sv√≠nakj√∂t", content: "Velti√∞ 800g af sv√≠nag√∫llasi upp √∫r kryddu√∞u gl√∫tenlausu mj√∂li. Br√∫ni√∞ √≠ potti. Taki√∞ kj√∂ti√∞ √∫r. Steiki√∞ 1 lauk og 2 gulr√¶tur. Setji√∞ kj√∂ti√∞ aftur √≠, helli√∞ vatni/so√∞i yfir. L√°ti√∞ malla √≠ a.m.k. 1.5 klst. Beri√∞ fram me√∞ kart√∂flum√∫s.", ingredients: { "Kj√∂t & Fiskur": ["Sv√≠nag√∫llas (800g)"], "Gr√¶nmeti & √Åvextir": ["Laukur (1)", "Gulr√¶tur (2)", "Kart√∂flur fyrir m√∫s"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Gl√∫tenlaust mj√∂l"] } },
            { title: "Taco-sk√°lar", category: "Nauta-/Hestakj√∂t", content: "Steiki√∞ 500g hakk og kryddi√∞ me√∞ taco-kryddi. Setji√∞ so√∞in hr√≠sgrj√≥n √≠ botninn √° sk√°lum. B√¶ti√∞ vi√∞ hakki, salati, t√≥m√∂tum, g√∫rku, ma√≠s, salsa, s√Ωr√∞um rj√≥ma og rifnum osti. Mylji√∞ ma√≠sfl√∂gur yfir.", ingredients: { "Kj√∂t & Fiskur": ["Nautahakk (500g)"], "Gr√¶nmeti & √Åvextir": ["Salat", "T√≥matar", "G√∫rka", "Ma√≠skorn"], "Mj√≥lkurv√∂rur & Egg": ["S√Ωr√∞ur rj√≥mi", "Rifinn ostur"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["Taco kryddmix", "Salsa s√≥sa", "Gl√∫tenlausar ma√≠sfl√∂gur", "Hr√≠sgrj√≥n"] } }
        ];

        const holidayMeals = {
            "3": { week: 3, dayIndex: 6, recipe: { title: "P√°skalamb üê£", category: "Lambakj√∂t", content: "Kryddi√∞ lambal√¶ri me√∞ salti, pipar, r√≥smar√≠n og hv√≠tlauk. Setji√∞ √≠ steikarpott me√∞ r√≥targr√¶nmeti. Eldi√∞ vi√∞ 160¬∞C √≠ 2-3 klst. Beri√∞ fram me√∞ br√∫nni s√≥su og kart√∂flum.", ingredients: { "Kj√∂t & Fiskur": ["Lambal√¶ri (1.5-2kg)"], "Gr√¶nmeti & √Åvextir": ["Hv√≠tlaukur", "R√≥targr√¶nmeti", "Kart√∂flur"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["R√≥smar√≠n"] } } },
            "11": { week: 2, dayIndex: 6, recipe: { title: "J√≥la-hamborgarhryggur üéÑ", category: "Sv√≠nakj√∂t", content: "Sj√≥√∞i√∞ hamborgarhrygg samkv√¶mt lei√∞beiningum. √ötb√∫i√∞ glj√°a √∫r p√∫√∞ursykri, sinnepi og ananassafa. Glj√°i√∞ og setji√∞ √≠ ofn √≠ 15-20 m√≠n vi√∞ 200¬∞C. Beri√∞ fram me√∞ eplasalati og rau√∞k√°li.", ingredients: { "Kj√∂t & Fiskur": ["Hamborgarhryggur (1.5kg)"], "√ûurrv√∂rur & Ni√∞ursu√∞a": ["P√∫√∞ursykur", "Sinnep", "Ananassafi"], "Gr√¶nmeti & √Åvextir": ["Epli", "Rau√∞k√°l"] } } }
        };
        
        const monthNames = ["Jan√∫ar", "Febr√∫ar", "Mars", "Apr√≠l", "Ma√≠", "J√∫n√≠", "J√∫l√≠", "√Åg√∫st", "September", "Okt√≥ber", "N√≥vember", "Desember"];
        let currentChart = null;
        let monthlyPlansCache = {};

        // --- Gemini API Function ---
        async function callGeminiAPI(prompt) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API kall t√≥kst ekki: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return "Ekkert svar barst fr√° gervigreindinni. Vinsamlegast reyni√∞ aftur.";
                }
            } catch (error) {
                console.error("Villa √≠ Gemini kalli:", error);
                return `Villa kom upp: ${error.message}. Vinsamlegast athugi√∞ v√©linat√∂lvuna (console) fyrir frekari uppl√Ωsingar.`;
            }
        }

        function formatRecipe(text) {
            return text
                .replace(/Titill:/g, '<h3 class="text-xl font-bold text-teal-700 mb-2">')
                .replace(/Hr√°efni:/g, '</h3><h4 class="text-lg font-semibold text-stone-800 mt-4 mb-2">Hr√°efni</h4><ul class="list-disc list-inside text-stone-700">')
                .replace(/A√∞fer√∞:/g, '</ul><h4 class="text-lg font-semibold text-stone-800 mt-4 mb-2">A√∞fer√∞</h4><div class="prose max-w-none text-stone-700">')
                .replace(/\*/g, '<li>')
                .replace(/\n/g, '<br>')
                .replace(/<br><li>/g, '</li><li>') + '</li></div>';
        }

        function showModal() {
            document.getElementById('ai-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function setModalLoading() {
            const contentDiv = document.getElementById('ai-modal-content');
            contentDiv.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>';
        }

        function setModalContent(htmlContent) {
            const contentDiv = document.getElementById('ai-modal-content');
            contentDiv.innerHTML = htmlContent;
        }

        document.getElementById('generate-new-recipe-btn').addEventListener('click', async () => {
            const userInput = document.getElementById('new-recipe-prompt').value;
            if (!userInput) {
                alert("Vinsamlegast sl√°√∞u inn hugmynd a√∞ uppskrift.");
                return;
            }
            const prompt = `B√∫√∞u til einfalda, gl√∫tenlausa uppskrift fyrir kv√∂ldmat fyrir 4 manna fj√∂lskyldu sem byggir √° √æessari hugmynd: "${userInput}". Sni√∞i√∞ svari√∞ me√∞ 'Titill:', 'Hr√°efni:', og 'A√∞fer√∞:'. Nota√∞u stj√∂rnur (*) fyrir hvert hr√°efni √° listanum.`;
            
            showModal();
            setModalLoading();
            const result = await callGeminiAPI(prompt);
            setModalContent(formatRecipe(result));
        });

        document.getElementById('generate-leftover-recipe-btn').addEventListener('click', async () => {
            const userInput = document.getElementById('leftover-prompt').value;
            if (!userInput) {
                alert("Vinsamlegast sl√°√∞u inn hva√∞a afganga √æ√∫ √°tt.");
                return;
            }
            const prompt = `B√∫√∞u til einfalda, gl√∫tenlausa uppskrift sem n√Ωtir eftirfarandi afganga: "${userInput}". Sni√∞i√∞ svari√∞ me√∞ 'Titill:', 'Hr√°efni:', og 'A√∞fer√∞:'. Nota√∞u stj√∂rnur (*) fyrir hvert hr√°efni √° listanum.`;

            showModal();
            setModalLoading();
            const result = await callGeminiAPI(prompt);
            setModalContent(formatRecipe(result));
        });

        document.getElementById('generate-lunch-recipe-btn').addEventListener('click', async () => {
            const userInput = document.getElementById('lunch-recipe-prompt').value;
            if (!userInput) {
                alert("Vinsamlegast sl√°√∞u inn hugmynd a√∞ h√°degismat.");
                return;
            }
            const prompt = `B√∫√∞u til einfalda, l√©tta og gl√∫tenlausa uppskrift fyrir h√°degismat fyrir eina manneskju sem byggir √° √æessari hugmynd: "${userInput}". Sni√∞i√∞ svari√∞ me√∞ 'Titill:', 'Hr√°efni:', og 'A√∞fer√∞:'. Nota√∞u stj√∂rnur (*) fyrir hvert hr√°efni √° listanum.`;
            
            showModal();
            setModalLoading();
            const result = await callGeminiAPI(prompt);
            setModalContent(formatRecipe(result));
        });

        document.getElementById('close-ai-modal-btn').addEventListener('click', hideModal);


        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateMonthlyPlan(monthIndex) {
            if (monthlyPlansCache[monthIndex]) {
                return monthlyPlansCache[monthIndex];
            }

            let plan = [];
            let availableRecipes = shuffle([...masterRecipes]);
            let recipeIndex = 0;

            for (let i = 0; i < 28; i++) {
                plan.push(availableRecipes[recipeIndex]);
                recipeIndex = (recipeIndex + 1) % availableRecipes.length;
            }

            const holiday = holidayMeals[monthIndex];
            if (holiday) {
                const holidayPlanIndex = (holiday.week * 7) + holiday.dayIndex;
                plan[holidayPlanIndex] = holiday.recipe;
            }
            
            monthlyPlansCache[monthIndex] = plan;
            return plan;
        }
        
        function generateShoppingList(weekPlan) {
            const shoppingList = {};
            weekPlan.forEach(dayPlan => {
                if (dayPlan && dayPlan.ingredients) {
                    for (const category in dayPlan.ingredients) {
                        if (!shoppingList[category]) {
                            shoppingList[category] = new Set();
                        }
                        dayPlan.ingredients[category].forEach(item => shoppingList[category].add(item));
                    }
                }
            });

            const formattedList = {};
            for (const category in shoppingList) {
                formattedList[category] = Array.from(shoppingList[category]);
            }
            return formattedList;
        }

        function renderWeek(weekPlan, weekNumber) {
            const planHtml = weekPlan.map((item, index) => {
                const dayNames = ["M√°nudagur", "√ûri√∞judagur", "Mi√∞vikudagur", "Fimmtudagur", "F√∂studagur", "Laugardagur", "Sunnudagur"];
                return `
                <div class="flex justify-between py-3 border-b border-stone-200">
                    <span class="font-semibold">${dayNames[index]}</span>
                    <span class="text-right">${item.title}</span>
                </div>
            `}).join('');

            const shoppingList = generateShoppingList(weekPlan);
            const shoppingListHtml = Object.keys(shoppingList).map(category => `
                <div class="mb-4">
                    <h4 class="font-bold text-teal-700 mb-2">${category}</h4>
                    <ul class="list-disc list-inside text-stone-700 space-y-1">
                        ${shoppingList[category].map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            `).join('');

            const recipeHtml = weekPlan.map(recipe => `
                <div class="border-t border-stone-200">
                    <button class="recipe-accordion-toggle w-full text-left py-4 px-1 flex justify-between items-center text-lg font-medium text-teal-800 hover:bg-stone-100">
                        <span>${recipe.title}</span>
                        <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="recipe-accordion-content px-2 pb-4 text-stone-700">
                       <div class="prose max-w-none">${recipe.content}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('plan-content').innerHTML = `
                <div class="week-content bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-teal-800">Vika ${weekNumber}</h2>
                        <button class="print-btn p-2 rounded-full hover:bg-stone-100 transition-colors" title="Prenta √æessa viku">
                            <svg class="w-6 h-6 text-teal-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        </button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8 lg:gap-12">
                        <div>
                            <h3 class="text-2xl font-bold mb-4 text-teal-700">Matse√∞ill</h3>
                            <div class="space-y-2">${planHtml}</div>
                             <div class="mt-8">
                                <h3 class="text-2xl font-bold mb-4 text-teal-700">Note üìù</h3>
                                <textarea class="w-full p-3 border border-stone-300 rounded-lg h-32 focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Skrifa√∞u minnispunkta fyrir vikuna h√©r..."></textarea>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold mb-4 text-teal-700">Innkaupalisti</h3>
                            <div>${shoppingListHtml}</div>
                        </div>
                    </div>
                    <div class="mt-12 bg-white rounded-2xl shadow-md overflow-hidden">
                        <h3 class="text-2xl font-bold p-6 bg-teal-50 text-teal-800">Uppskriftir Vikunnar</h3>
                        ${recipeHtml}
                    </div>
                </div>
            `;
            
            document.querySelector('.print-btn').addEventListener('click', () => {
                window.print();
            });

            document.querySelectorAll('.recipe-accordion-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('svg');
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.style.transform = 'rotate(180deg)';
                    }
                });
            });
        }

        function updateChart(monthlyPlan) {
            const categoryCounts = {};
            masterRecipes.forEach(r => categoryCounts[r.category] = 0);
            
            monthlyPlan.forEach(meal => {
                if (meal && meal.category && categoryCounts.hasOwnProperty(meal.category)) {
                    categoryCounts[meal.category]++;
                } else if (meal && meal.category) { 
                    categoryCounts[meal.category] = (categoryCounts[meal.category] || 0) + 1;
                }
            });

            const labels = Object.keys(categoryCounts);
            const data = Object.values(categoryCounts);
            
            const backgroundColors = ['#145A32', '#117864', '#48C9B0', '#A3E4D7', '#D1F2EB', '#0E6655'];

            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('mealTypeChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Fj√∂ldi m√°lt√≠√∞a',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 14, family: 'Inter' }, color: '#44403c' } } }
                }
            });
        }

        function displayMonth(monthIndex) {
            const monthlyPlan = generateMonthlyPlan(monthIndex);
            
            document.getElementById('chart-section').style.display = 'block';
            document.getElementById('chart-title').innerText = `Yfirlit fyrir ${monthNames[monthIndex]}`;
            updateChart(monthlyPlan);

            const weekNav = document.getElementById('week-nav');
            weekNav.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const button = document.createElement('button');
                button.dataset.weekIndex = i;
                button.innerText = `Vika ${i + 1}`;
                button.className = 'week-btn bg-white text-teal-700 py-2 px-5 rounded-full font-semibold shadow-md transition-transform transform hover:scale-105';
                weekNav.appendChild(button);
            }
            weekNav.style.display = 'flex';

            weekNav.querySelectorAll('.week-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const weekIndex = parseInt(e.target.dataset.weekIndex);
                    const weekPlan = monthlyPlan.slice(weekIndex * 7, (weekIndex + 1) * 7);
                    renderWeek(weekPlan, weekIndex + 1);

                    weekNav.querySelectorAll('.week-btn').forEach(btn => {
                        btn.classList.remove('bg-teal-700', 'text-white');
                        btn.classList.add('bg-white', 'text-teal-700');
                    });
                    e.target.classList.add('bg-teal-700', 'text-white');
                    e.target.classList.remove('bg-white', 'text-teal-700');
                });
            });
            
            if (weekNav.querySelector('.week-btn')) {
                weekNav.querySelector('.week-btn').click();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const monthSelector = document.getElementById('month-selector');
            const currentMonth = new Date().getMonth();

            monthNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.innerText = name;
                if (index === currentMonth) {
                    option.selected = true;
                }
                monthSelector.appendChild(option);
            });

            monthSelector.addEventListener('change', (e) => {
                displayMonth(e.target.value);
            });
            
            displayMonth(currentMonth);
        });
    </script>
</body>
</html>
